#+TITLE: Emacs 配置文件
#+AUTHOR: Vietor Liu
#+PROPERTY: header-args :tangle yes
#+STARTUP: overview
#+OPTIONS: num:nil

* 项目目标

我本人自2013年就开始使用了Emacs，直至今时已经自己迭代了很多版本，主要参考[[https://github.com/purcell/emacs.d][Steve Purcell]]的配置。
国人使用Emacs的并不常见，猜测是因为Emacs入门麻烦；为了启发的Emacs初学者，创建这个项目以供参考用。

** 试用方法

将这个项目直接clone到个人主目录后，打开Emacs即可。

#+BEGIN_SRC bash
  git clone https://github.com/vietor/dot-emacs.d.git ~/.emacs.d
#+END_SRC

* 正式配置

** 包管理

不要质疑use-package，它已经进入Emacs内部了。

#+BEGIN_SRC emacs-lisp
  (require 'package)

  (dolist (archive '(("gnu"    . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
                     ("nongnu" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/nongnu/")
                     ("melpa"  . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")))
    (unless (assoc (car archive) package-archives)
      (add-to-list 'package-archives archive t)))

  (setq package-user-dir
        (expand-file-name (format "elpa-%s.%s" emacs-major-version emacs-minor-version)
                          user-emacs-directory))

  (unless (bound-and-true-p package--initialized)
    (setq package-check-signature nil
          package-enable-at-startup nil)
    (package-initialize))

  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package))

#+END_SRC


** 项目管理

Emacs自身已经包含了*project*来进行简单项目管理，但我个人喜欢*多开*就写了个*aproject*，尽量让每个项目有独立的环境。

#+BEGIN_SRC emacs-lisp
  (use-package aproject
    :ensure t
    :demand t
    :bind ("C-x p" . aproject-change-project)
    :config
    (setq desktop-restore-eager 5)
    (setq aproject-plugin-environ t)
    (add-to-list 'vc-directory-exclusion-list aproject-dirname))

  (when window-system
    (defun open-new-emacs()
      "Open a new Emacs process."
      (interactive)
      (cond
       ((eq system-type 'darwin)
        (shell-command "open -n -a Emacs.app"))
       ((eq system-type 'windows-nt)
        (w32-shell-execute "open" (concat (file-name-directory (car command-line-args)) "runemacs.exe")))
       (t (call-process-shell-command (concat (car command-line-args) " & disown")))))

    (bind-key "M-g z" 'open-new-emacs))
#+END_SRC

** 界面优化

*** 简化界面

#+BEGIN_SRC emacs-lisp
  (when (fboundp 'tooltip-mode)
    (tooltip-mode -1))
  (when (fboundp 'menu-bar-mode)
    (menu-bar-mode -1))
  (when (fboundp 'tool-bar-mode)
    (tool-bar-mode -1))
  (when (fboundp 'scroll-bar-mode)
    (scroll-bar-mode -1))
  (when (fboundp 'horizontal-scroll-bar-mode)
    (horizontal-scroll-bar-mode -1))

  (setq default-frame-alist '((vertical-scroll-bars . nil)
                              (tool-bar-lines . 0)
                              (menu-bar-lines . 0)
                              (fullscreen . nil)))
  (let ((no-border '(internal-border-width . 0)))
    (add-to-list 'default-frame-alist no-border)
    (add-to-list 'initial-frame-alist no-border))
#+END_SRC

*** 简化操作

#+BEGIN_SRC emacs-lisp
  (dolist (key '("<f1>" "<f2>" "<f3>" "<f4>" "<f5>" "<f6>" "<f7>" "<f8>" "<f9>" "<f10>" "<f11>" "<f12>"
                 "C-z" "C-SPC" "C-x C-z" "C-x C-e"))
    (global-unset-key (kbd key)))

  (setq confirm-kill-processes nil)
  (defalias 'yes-or-no-p 'y-or-n-p)

  (setq create-lockfiles nil
        make-backup-files nil
        auto-save-default nil
        auto-save-list-file-prefix nil)

  (blink-cursor-mode 0)
  (setq visible-bell nil
        ring-bell-function 'ignore)

  (when window-system
    (setq use-dialog-box nil
          use-file-dialog nil)

    (mouse-wheel-mode t)
    (setq mouse-wheel-scroll-amount '(1
                                      ((shift) . 5)
                                      ((control))))
    ;; disable ugly text-scale
    (defun mouse-wheel-text-scale (event)
      (interactive (list last-input-event))))

  (when (fboundp 'pixel-scroll-precision-mode)
    (pixel-scroll-precision-mode))

  (when (eq system-type 'darwin)
    (setq ns-pop-up-frames nil
          mac-command-modifier 'meta
          mac-option-modifier 'none)
    (set-fontset-font t 'symbol (font-spec :family "Apple Color Emoji") nil 'prepend))

  (when (eq system-type 'windows-nt)
    (setq w32-pipe-read-delay 0
          w32-pipe-buffer-size (* 64 1024)
          w32-get-true-file-attributes nil
          inhibit-compacting-font-caches t))
  (setq-default bidi-display-reordering nil)

  (when (fboundp 'toggle-frame-fullscreen)
    (bind-key "C-<f10>" 'toggle-frame-fullscreen))
#+END_SRC

*** 优化编辑器

#+BEGIN_SRC emacs-lisp
  (put 'narrow-to-region 'disabled nil)
  (put 'narrow-to-page 'disabled nil)
  (put 'narrow-to-defun 'disabled nil)
  (put 'downcase-region 'disabled nil)
  (put 'upcase-region 'disabled nil)

  (setq inhibit-startup-screen t
        initial-scratch-message "")
  (setq-default major-mode 'text-mode)
  (setq initial-major-mode 'text-mode)

  (cua-selection-mode t)
  (add-hook 'after-init-hook 'show-paren-mode)
  (add-hook 'after-init-hook 'transient-mark-mode)
  (add-hook 'after-init-hook 'delete-selection-mode)

  (setq-default tab-width 4
                standard-indent 4
                indent-tabs-mode nil
                case-fold-search t
                truncate-lines nil
                truncate-partial-width-windows nil
                indicate-empty-lines t
                column-number-mode t
                shift-select-mode nil
                sentence-end-double-space nil
                mouse-yank-at-point t
                save-interprogram-paste-before-kill t
                scroll-preserve-screen-position 'always
                set-mark-command-repeat-pop t)

  (add-hook 'c-mode-common-hook
            (lambda()
              (when indent-tabs-mode (setq tab-width c-basic-offset))))

  (when (fboundp 'display-line-numbers-mode)
    (setq-default display-line-numbers-width 3)
    (add-hook 'prog-mode-hook 'display-line-numbers-mode))

  (when (fboundp 'electric-pair-mode)
    (add-hook 'after-init-hook 'electric-pair-mode))
  (add-hook 'after-init-hook 'electric-indent-mode)

  (setq-default show-trailing-whitespace nil)
  (dolist (hook '(prog-mode-hook text-mode-hook conf-mode-hook))
    (add-hook hook (lambda () (setq show-trailing-whitespace t))))
#+END_SRC

